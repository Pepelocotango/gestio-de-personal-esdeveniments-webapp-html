<!DOCTYPE html>
<!-- v.6 - Datalists, Reorganització, Nous Resums Agrupats -->
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestió Avançada d'Esdeveniments Personals v6</title>
    <style>
        /* --- CSS Variables (igual que v5) --- */
        :root {
            --primary-color: #0056b3; --secondary-color: #5a6268; --success-color: #218838;
            --danger-color: #c82333; --warning-color: #e0a800; --info-color: #117a8b;
            --light-color: #f8f9fa; --dark-color: #343a40; --border-color: #ced4da;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --status-pending-bg: #ffeeba; --status-yes-bg: #c3e6cb; --status-no-bg: #f5c6cb;
            --mobile-breakpoint: 768px;
        }

        /* --- Reset & Body (igual que v5) --- */
        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family); margin: 0; padding: 10px; background-color: var(--light-color);
            color: var(--dark-color); line-height: 1.6; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }

        /* --- Container & Headings (igual que v5) --- */
        .container {
            max-width: 1100px; margin: 15px auto; background-color: #fff; padding: 20px 25px;
            border-radius: 8px; box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08); overflow: hidden;
        }
        h1, h2, h3 { margin-top: 0; }
        h1 { color: var(--primary-color); text-align: center; margin-bottom: 30px; font-size: 1.8rem; }
        h2 { color: var(--primary-color); text-align: center; margin-bottom: 20px; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; gap: 0.5em;}
        h3 { color: var(--secondary-color); text-align: left; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; display: flex; align-items: center; font-size: 1.15rem; gap: 0.5em;}
        h3 svg, h2 svg { flex-shrink: 0; width: 1.1em; height: 1.1em; }

        /* --- Helper Classes (igual que v5) --- */
        .hidden { display: none !important; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        .section { margin-bottom: 30px; padding: 20px; background-color: #fdfdfd; border-radius: 5px; border: 1px solid var(--border-color); }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;}

        /* --- Buttons (General - igual que v5) --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5em; padding: 10px 20px; font-size: 0.95rem; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease; text-align: center; text-decoration: none; white-space: nowrap; }
        .btn svg { width: 1em; height: 1em; }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-primary:hover { background-color: #004494; }
        .btn-secondary { background-color: var(--secondary-color); color: white; } .btn-secondary:hover { background-color: #495057; }
        .btn-success { background-color: var(--success-color); color: white; } .btn-success:hover { background-color: #1e7e34; }
        .btn-danger { background-color: var(--danger-color); color: white; } .btn-danger:hover { background-color: #b21f2d; }
        .btn-warning { background-color: var(--warning-color); color: var(--dark-color); } .btn-warning:hover { background-color: #c89400; }
        .btn-info { background-color: var(--info-color); color: white; } .btn-info:hover { background-color: #0f6674; }
        .btn-light { background-color: var(--light-color); color: var(--dark-color); border: 1px solid var(--border-color); } .btn-light:hover { background-color: #e2e6ea; }
        .btn-icon { background-color: transparent; padding: 4px 6px; font-size: 1.1rem; line-height: 1; vertical-align: middle; }
        .btn-icon.btn-danger { color: var(--danger-color); } .btn-icon.btn-danger:hover { background-color: var(--danger-color); color: white; }
        .btn-icon.btn-warning { color: #b88100; } .btn-icon.btn-warning:hover { background-color: var(--warning-color); color: var(--dark-color); }

        /* --- Form Styling (igual que v5) --- */
        #event-form { margin-bottom: 0; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
        label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 0.95rem; color: var(--secondary-color); }
        input[type="text"], input[type="date"], input[type="search"], select, textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; font-family: inherit; background-color: #fff; color: var(--dark-color); }
        input[type="date"] { min-height: calc(1.6em + 20px + 2px); appearance: none; }
        textarea { min-height: 80px; resize: vertical; }
        #event-form button[type="submit"] { width: auto; flex-grow: 1;}
        #clear-form-btn, #cancel-edit-btn { width: auto; }
        /* Make datalist arrows less intrusive if needed */
        input::-webkit-calendar-picker-indicator { opacity: 0.6; }

        /* --- Filter Controls (igual que v5) --- */
        #filter-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end; }
        #filter-controls .form-group { margin-bottom: 0; }
        #reset-filters-btn { white-space: nowrap; }

        /* --- Table Styling (igual que v5, incl. sort indicators) --- */
        #events-table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; vertical-align: middle; word-break: break-word; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; white-space: nowrap; font-size: 0.95rem; position: relative; }
        th[data-sort-key] { cursor: pointer; user-select: none; padding-right: 25px; }
        th[data-sort-key]:hover { background-color: #004494; }
        .sort-indicator { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.8em; }
        #events-table tr:nth-child(even):not([class*="status-"]) { background-color: #f7f7f7; }
        #events-table td { font-size: 0.95rem; }
        .status-select { padding: 6px 8px; border-radius: 4px; border: 1px solid var(--border-color); min-width: 100px; font-size: 0.9rem; background-color: #fff; cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 2em; }
        .actions-cell { white-space: nowrap; text-align: right; }
        .actions-cell button { margin-left: 5px; }
        #events-table tr.status-Pendent { background-color: var(--status-pending-bg); }
        #events-table tr.status-Sí { background-color: var(--status-yes-bg); }
        #events-table tr.status-No { background-color: var(--status-no-bg); }
        #events-table tr.status-Pendent:nth-child(even),
        #events-table tr.status-Sí:nth-child(even),
        #events-table tr.status-No:nth-child(even) { background-color: inherit; }

        /* --- Summaries Styling (NOU FORMAT) --- */
        #summaries { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .summary-container { padding: 15px; background-color: #fdfdfd; border: 1px solid var(--border-color); border-radius: 5px; }
        .summary-container table { margin-top: 10px; }
        .summary-container table th { background-color: var(--secondary-color); font-size: 0.85rem; padding: 8px 10px;}
        .summary-container table td { font-size: 0.9rem; padding: 8px 10px; vertical-align: top;}
        /* New style for group headers within summary tables */
        .summary-group-header td {
            font-weight: bold;
            background-color: #e9ecef;
            color: var(--secondary-color);
            padding: 8px 10px;
            font-size: 0.9rem;
            border-top: 2px solid var(--border-color); /* Separator */
        }
        .summary-group-header:first-child td {
             border-top: none; /* No top border for the very first header */
        }
        /* Status indicators in summaries */
        .status-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px; /* Pill shape */
            font-size: 0.8rem;
            color: white;
            white-space: nowrap;
        }
        .status-indicator-Pendent { background-color: var(--warning-color); color: var(--dark-color);}
        .status-indicator-Sí { background-color: var(--success-color); }
        .status-indicator-No { background-color: var(--danger-color); }

        .no-data-message { text-align: center; display: none; margin: 15px 0; padding: 12px; color: var(--secondary-color); background-color: #f0f0f0; border-radius: 4px; font-style: italic; }

        /* --- Modal Styling (igual que v5) --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content { background-color: white; padding: 25px 30px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); max-width: 500px; width: 90%; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-header { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .modal-title { color: var(--primary-color); font-size: 1.25rem; margin-bottom: 0; }
        .modal-body { margin-bottom: 20px; color: var(--dark-color); }
        .modal-footer { text-align: right; } .modal-footer .btn { margin-left: 10px; }

        /* --- Feedback Area (igual que v5) --- */
        #feedback-area { position: fixed; bottom: 20px; right: 20px; background-color: var(--dark-color); color: white; padding: 10px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1010; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        #feedback-area.visible { opacity: 1; visibility: visible; transition-delay: 0s; }

        /* --- Data Management (igual que v5) --- */
        .data-management-container { display: flex; gap: 15px; flex-wrap: wrap; }
        #import-file-input { display: none; }

        /* --- Responsive adjustments (igual que v5, amb ajustos menors si cal) --- */
        @media (max-width: var(--mobile-breakpoint)) {
            .container { padding: 15px; max-width: 100%; }
            h1 { font-size: 1.6rem; margin-bottom: 20px; }
            h2 { font-size: 1.3rem; margin-bottom: 15px; }
            h3 { font-size: 1.1rem; }
            .section { padding: 15px; }
            .form-row { flex-direction: column; gap: 0; }
            .form-row .form-group { margin-bottom: 15px; }
            #filter-controls { grid-template-columns: 1fr; }

            /* Main table card list (igual que v5) */
            #events-table thead { display: none; }
            #events-table tr { display: block; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 5px; box-shadow: 0 1px 4px rgba(0,0,0,0.07); background-color: #fff !important; border-left-width: 5px; border-left-style: solid; padding-left: 0; }
            #events-table tr.status-Pendent { border-left-color: var(--warning-color); }
            #events-table tr.status-Sí { border-left-color: var(--success-color); }
            #events-table tr.status-No { border-left-color: var(--danger-color); }
            #events-table td { display: block; text-align: right; padding-left: 45%; position: relative; border: none; border-bottom: 1px dotted var(--border-color); padding-top: 10px; padding-bottom: 10px; min-height: 42px; font-size: 0.9rem; background-color: transparent !important; word-break: break-word; }
            #events-table tr td:last-child { border-bottom: none; }
            #events-table td::before { content: attr(data-label); position: absolute; left: 10px; width: 40%; padding-right: 10px; white-space: nowrap; font-weight: bold; text-align: left; color: var(--secondary-color); font-size: 0.85rem; }
            #events-table .status-select { width: auto; float: right; max-width: 110px; padding: 5px 2em 5px 8px; font-size: 0.85rem; }
            #events-table .actions-cell { text-align: right; padding-left: 10px; }
            #events-table .actions-cell::before { width: auto; position: static; margin-right: auto; }
            #events-table .actions-cell button { float: right; margin-left: 5px; margin-top: 0; padding: 5px 8px; }

            #summaries { grid-template-columns: 1fr; } /* Stack summaries */
             /* Optional: Make summary tables more responsive if needed */
             /* .summary-container table { display: block; overflow-x: auto; } */
        }

        @media (max-width: 480px) {
             h1 { font-size: 1.4rem; }
             .btn { font-size: 0.9rem; padding: 8px 15px;}
             .form-actions { flex-direction: column; align-items: stretch;}
             .form-actions .btn { width: 100%; }
             #events-table td { padding-left: 10px; text-align: left;}
             #events-table td::before { position: static; display: block; width: 100%; font-weight: bold; margin-bottom: 3px; white-space: normal;}
             #events-table .status-select { float: none; max-width: none; width: 100%; margin-top: 5px;}
             #events-table .actions-cell { text-align: left; }
             #events-table .actions-cell::before { margin-bottom: 5px; }
             #events-table .actions-cell button { float: none; display: inline-block; margin-left: 0; margin-right: 5px; margin-top: 5px; }
             .modal-content { width: 95%; padding: 20px; }
             .data-management-container { flex-direction: column; align-items: stretch;}
             .data-management-container .btn { width: 100%; }
             .summary-container table thead { display: none; } /* Hide headers on very small screens */
             .summary-container table tr { display: block; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
             .summary-container table tr.summary-group-header { border-bottom: none; padding-bottom: 0; margin-bottom: 5px;}
             .summary-container table td { display: block; text-align: right; padding-left: 40%; position: relative; border: none; }
             .summary-container table td::before { content: attr(data-label); /* Get label from data attribute */ position: absolute; left: 8px; width: 35%; padding-right: 10px; white-space: nowrap; font-weight: bold; text-align: left; font-size: 0.8rem; color: var(--secondary-color);}
             .summary-container tr.summary-group-header td { text-align: left; padding-left: 8px; }
             .summary-container tr.summary-group-header td::before { display: none; } /* Hide label for header */
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Gestió Avançada d'Esdeveniments v6</h1>

        <!-- Data Management Section (TOP) -->
        <div id="data-management-section-top" class="section">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line><polyline points="7 16 12 21 17 16"></polyline><line x1="12" y1="21" x2="12" y2="9"></line></svg>
                Gestió de Dades
            </h3>
            <div class="data-management-container">
                <button id="export-data-btn-top" class="btn btn-info">
                     <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Exportar Dades (JSON)
                </button>
                <button id="import-data-btn-top" class="btn btn-warning">
                     <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Importar Dades (JSON)
                </button>
                <input type="file" id="import-file-input" accept=".json"> <!-- Only one needed -->
            </div>
        </div>

        <!-- Form to add/edit events -->
        <form id="event-form" class="section">
            <h2 id="form-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                Afegir Esdeveniment
            </h2>
            <input type="hidden" id="edit-event-id">
             <div class="form-group">
                <label for="event-name">Nom de l'Esdeveniment:</label>
                <input type="text" id="event-name" required aria-required="true" list="event-name-datalist">
                <datalist id="event-name-datalist"></datalist> <!-- DATALIST -->
            </div>
             <div class="form-row">
                 <div class="form-group">
                    <label for="start-date">Data Inici:</label>
                    <input type="date" id="start-date" required aria-required="true">
                </div>
                 <div class="form-group">
                    <label for="end-date">Data Fi (Opcional):</label>
                    <input type="date" id="end-date" aria-describedby="end-date-desc">
                     <small id="end-date-desc" style="color: var(--secondary-color); font-size: 0.8rem;">Deixar buit si és un sol dia.</small>
                </div>
            </div>
            <div class="form-group">
                <label for="person-name">Nom Persona / Grup:</label>
                <input type="text" id="person-name" required aria-required="true" list="person-name-datalist">
                 <datalist id="person-name-datalist"></datalist> <!-- DATALIST -->
            </div>
            <div class="form-group">
                <label for="status">Estat:</label>
                <select id="status">
                    <option value="Pendent" selected>Pendent</option>
                    <option value="Sí">Confirmat (Sí)</option>
                    <option value="No">Cancel·lat (No)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="notes">Notes:</label>
                <textarea id="notes" placeholder="(Opcional)"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" id="submit-btn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span id="submit-btn-text">Afegir</span>
                </button>
                 <button type="button" id="clear-form-btn" class="btn btn-light">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    Netejar
                </button>
                <button type="button" id="cancel-edit-btn" class="btn btn-secondary hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    Cancel·lar Edició
                </button>
            </div>
        </form>

        <!-- Main Events List -->
        <div class="section">
            <h2 id="events-list-title" style="display: none;">
                 <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><line x1="8" y1="14" x2="16" y2="14"></line></svg>
                Llista d'Esdeveniments (<span id="event-count">0</span>)
            </h2>
            <div id="events-table-wrapper">
                 <table id="events-table" style="display: none;">
                    <thead>
                        <tr>
                            <!-- Headers order changed slightly -->
                            <th data-sort-key="eventName">Esdeveniment <span class="sort-indicator"></span></th>
                            <th data-sort-key="startDate">Dates <span class="sort-indicator"></span></th>
                            <th data-sort-key="name">Persona/Grup <span class="sort-indicator"></span></th>
                            <th data-sort-key="status">Estat <span class="sort-indicator"></span></th>
                            <th>Notes</th>
                            <th>Accions</th>
                        </tr>
                    </thead>
                    <tbody></tbody> <!-- Populated by JS using template -->
                </table>
            </div>
            <p id="no-events-message" class="no-data-message" style="display: block;">Encara no hi ha cap esdeveniment.</p>
        </div>

         <!-- Filter Controls -->
        <div id="filter-controls-section" class="section">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                Filtres i Cerca
            </h3>
             <div id="filter-controls">
                <div class="form-group">
                    <label for="filter-search">Cercar (Nom, Esdeveniment, Notes):</label>
                    <input type="search" id="filter-search" placeholder="Escriu per cercar...">
                </div>
                <div class="form-group">
                    <label for="filter-status">Filtrar per Estat:</label>
                    <select id="filter-status">
                        <option value="">-- Tots --</option>
                        <option value="Pendent">Pendent</option>
                        <option value="Sí">Confirmat (Sí)</option>
                        <option value="No">Cancel·lat (No)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-start-date">Des de Data Inici:</label>
                    <input type="date" id="filter-start-date">
                </div>
                <div class="form-group">
                    <label for="filter-end-date">Fins a Data Inici:</label>
                    <input type="date" id="filter-end-date">
                </div>
                <button id="reset-filters-btn" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    Netejar Filtres
                </button>
            </div>
        </div>

        <!-- Summaries Section (NOU FORMAT) -->
        <div id="summaries-section" class="section" style="display: none;">
             <h2>
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>
                Resums Agrupats
            </h2>
            <div id="summaries">
                <!-- Summary By Event Name -->
                <div id="summary-by-event-container" class="summary-container">
                    <h3>
                         <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                         Agrupat per Nom Esdeveniment
                    </h3>
                    <div class="table-responsive-summary">
                         <table id="summary-by-event">
                            <thead><tr><th>Persona/Grup</th><th>Dates</th><th>Estat</th></tr></thead>
                            <tbody id="summary-by-event-tbody"></tbody>
                        </table>
                    </div>
                    <p id="no-summary-event" class="no-data-message">No hi ha dades per nom d'esdeveniment.</p>
                </div>
                 <!-- Summary By Date -->
                <div id="summary-by-date-container" class="summary-container">
                    <h3>
                         <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                         Agrupat per Data Inici
                    </h3>
                    <div class="table-responsive-summary">
                        <table id="summary-by-date">
                            <thead><tr><th>Esdeveniment</th><th>Persona/Grup</th><th>Estat</th></tr></thead>
                            <tbody id="summary-by-date-tbody"></tbody>
                        </table>
                    </div>
                    <p id="no-summary-date" class="no-data-message">No hi ha dades per data.</p>
                </div>
                <!-- Summary By Person/Group -->
                <div id="summary-by-person-container" class="summary-container">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                         Agrupat per Persona/Grup
                    </h3>
                     <div class="table-responsive-summary">
                        <table id="summary-by-person">
                             <thead><tr><th>Esdeveniment</th><th>Dates</th><th>Estat</th></tr></thead>
                            <tbody id="summary-by-person-tbody"></tbody>
                        </table>
                    </div>
                    <p id="no-summary-person" class="no-data-message">No hi ha dades per persona/grup.</p>
                </div>
            </div>
        </div>

         <!-- Data Management Section (BOTTOM) -->
        <div id="data-management-section-bottom" class="section">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line><polyline points="7 16 12 21 17 16"></polyline><line x1="12" y1="21" x2="12" y2="9"></line></svg>
                Gestió de Dades
            </h3>
            <div class="data-management-container">
                <button id="export-data-btn-bottom" class="btn btn-info">
                     <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Exportar Dades (JSON)
                </button>
                <button id="import-data-btn-bottom" class="btn btn-warning">
                     <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Importar Dades (JSON)
                </button>
                 <!-- File input remains the same, just triggered by two buttons -->
            </div>
        </div>

    </div> <!-- End container -->

    <!-- Template for event row (igual que v5, but ensure class names match JS selectors) -->
    <template id="event-row-template">
        <tr>
            <td data-label="Esdeveniment" class="event-event-name"></td>
            <td data-label="Dates" class="event-dates"></td>
            <td data-label="Persona/Grup" class="event-person-name"></td>
            <td data-label="Estat">
                <select class="status-select" aria-label="Canviar estat">
                    <option value="Pendent">Pendent</option>
                    <option value="Sí">Confirmat (Sí)</option>
                    <option value="No">Cancel·lat (No)</option>
                </select>
            </td>
            <td data-label="Notes" class="event-notes"></td>
            <td data-label="Accions" class="actions-cell">
                <button class="edit-btn btn btn-icon btn-warning" title="Editar esdeveniment">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    <span class="visually-hidden">Editar</span>
                </button>
                <button class="delete-btn btn btn-icon btn-danger" title="Eliminar esdeveniment">
                   <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    <span class="visually-hidden">Eliminar</span>
                </button>
            </td>
        </tr>
    </template>

    <!-- Confirmation Modal (igual que v5) -->
    <div id="confirmation-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <div class="modal-header"><h4 id="modal-title" class="modal-title">Confirmació</h4></div>
            <div class="modal-body"><p id="modal-message">Estàs segur?</p></div>
            <div class="modal-footer">
                <button id="modal-cancel-btn" class="btn btn-light">Cancel·lar</button>
                <button id="modal-confirm-btn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Feedback Area (igual que v5) -->
    <div id="feedback-area" aria-live="assertive"></div>

    <script>
        // --- Constants ---
        const LOCAL_STORAGE_KEY = 'personalEventsApp_v6';
        const DEBOUNCE_DELAY = 300;

        // --- DOM Element References ---
        // Form & Datalists
        const eventForm = document.getElementById('event-form');
        const formTitle = document.getElementById('form-title');
        const personNameInput = document.getElementById('person-name');
        const personNameDatalist = document.getElementById('person-name-datalist'); // New
        const eventNameInput = document.getElementById('event-name');
        const eventNameDatalist = document.getElementById('event-name-datalist'); // New
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const statusInput = document.getElementById('status');
        const notesInput = document.getElementById('notes');
        const editEventIdInput = document.getElementById('edit-event-id');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnText = document.getElementById('submit-btn-text');
        const clearFormBtn = document.getElementById('clear-form-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        // Filters
        const filterControlsSection = document.getElementById('filter-controls-section'); // Section container
        const filterControls = document.getElementById('filter-controls');
        const filterSearchInput = document.getElementById('filter-search');
        const filterStatusSelect = document.getElementById('filter-status');
        const filterStartDateInput = document.getElementById('filter-start-date');
        const filterEndDateInput = document.getElementById('filter-end-date');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');

        // Table & List
        const eventsTableWrapper = document.getElementById('events-table-wrapper');
        const eventsTable = document.getElementById('events-table');
        const eventsTableBody = eventsTable.querySelector('tbody');
        const eventsTableHeader = eventsTable.querySelector('thead');
        const noEventsMessage = document.getElementById('no-events-message');
        const eventsListTitle = document.getElementById('events-list-title');
        const eventCountSpan = document.getElementById('event-count');
        const eventRowTemplate = document.getElementById('event-row-template');

        // Summaries (Containers & Bodies)
        const summariesSection = document.getElementById('summaries-section');
        const summaryByEventContainer = document.getElementById('summary-by-event-container');
        const summaryByDateContainer = document.getElementById('summary-by-date-container');
        const summaryByPersonContainer = document.getElementById('summary-by-person-container');
        const summaryByEventTableBody = document.getElementById('summary-by-event-tbody');
        const summaryByDateTableBody = document.getElementById('summary-by-date-tbody');
        const summaryByPersonTableBody = document.getElementById('summary-by-person-tbody');
        const noSummaryEventMsg = document.getElementById('no-summary-event');
        const noSummaryDateMsg = document.getElementById('no-summary-date');
        const noSummaryPersonMsg = document.getElementById('no-summary-person');

        // Modal
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

         // Feedback
        const feedbackArea = document.getElementById('feedback-area');

        // Data Management (Top and Bottom buttons trigger the same input)
        const exportBtnTop = document.getElementById('export-data-btn-top');
        const importBtnTop = document.getElementById('import-data-btn-top');
        const exportBtnBottom = document.getElementById('export-data-btn-bottom');
        const importBtnBottom = document.getElementById('import-data-btn-bottom');
        const importFileInput = document.getElementById('import-file-input');

        // --- Application State (igual que v5) ---
        let appState = {
            events: [], filters: { search: '', status: '', startDate: '', endDate: '' },
            sort: { key: 'startDate', direction: 'desc' },
            editingEventId: null, modalCallback: null
        };
        let searchDebounceTimeout;

        // --- Utility Functions (igual que v5, possiblement amb petits ajustos) ---
        const Utils = {
            getEvents: () => { /* ... (igual que v5) ... */
                 try { const storedData = localStorage.getItem(LOCAL_STORAGE_KEY); const parsedData = storedData ? JSON.parse(storedData) : []; if (!Array.isArray(parsedData)) { console.warn("Invalid data format in localStorage. Resetting."); return []; } return parsedData.map(event => ({ id: event.id || Date.now() + Math.random(), name: event.name || 'Sense Nom Persona', eventName: event.eventName || 'Sense Nom Esdeveniment', startDate: event.startDate || null, endDate: event.endDate || null, status: event.status || 'Pendent', notes: event.notes || '' })); } catch (e) { console.error("Error parsing events from localStorage:", e); Utils.showFeedback("Error carregant les dades. S'ha restablert la llista.", 'error', 5000); localStorage.removeItem(LOCAL_STORAGE_KEY); return []; }
            },
            saveEvents: (events) => { /* ... (igual que v5) ... */
                 try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(events)); } catch (e) { console.error("Error saving events to localStorage:", e); Utils.showModal( "Error de Guardat", "No s'han pogut desar les dades. L'emmagatzematge local podria estar ple o inaccessible. Les darreres modificacions podrien perdre's en tancar.", null, 'error' ); }
            },
            escapeHTML: (str) => { /* ... (igual que v5) ... */
                 if (typeof str !== 'string') return str; const p = document.createElement('p'); p.textContent = str; return p.innerHTML;
            },
            formatDateRange: (startDateStr, endDateStr) => { /* ... (igual que v5) ... */
                 if (!startDateStr || !/^\d{4}-\d{2}-\d{2}$/.test(startDateStr)) return 'N/D'; const formatSingle = (dateStr) => { try { const [y, m, d] = dateStr.split('-'); const dt = new Date(Date.UTC(y, m - 1, d)); return isNaN(dt.getTime()) ? 'Invàlid' : dt.toLocaleDateString('ca-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }); } catch { return 'Error'; } }; const startFormatted = formatSingle(startDateStr); if (!endDateStr || !/^\d{4}-\d{2}-\d{2}$/.test(endDateStr) || startDateStr === endDateStr) { return startFormatted; } const endFormatted = formatSingle(endDateStr); if (startFormatted.match(/Invàlid|Error|N\/D/) || endFormatted.match(/Invàlid|Error|N\/D/)) { return `${startFormatted} - ${endFormatted}`; } try { const start = new Date(startDateStr); const end = new Date(endDateStr); return end >= start ? `${startFormatted} - ${endFormatted}` : startFormatted; } catch { return `${startFormatted} - ${endFormatted}`; }
             },
            formatSingleDate: (dateStr) => { // Simplified version for summaries
                 if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return 'N/D';
                 try {
                     const [y, m, d] = dateStr.split('-');
                     const dt = new Date(Date.UTC(y, m - 1, d));
                     return isNaN(dt.getTime()) ? 'Invàlid' : dt.toLocaleDateString('ca-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                 } catch { return 'Error'; }
             },
             getUniqueValues: (events, key) => { // Helper for datalists
                const values = new Set();
                events.forEach(event => {
                    const value = (event[key] || '').trim();
                    if (value) {
                        values.add(value); // Add the original case but check uniqueness case-insensitively later if needed, or let datalist handle it
                    }
                });
                return Array.from(values).sort((a, b) => a.localeCompare(b, 'ca', { sensitivity: 'base' }));
            },
            showModal: (title, message, confirmCallback, type = 'danger') => { /* ... (igual que v5) ... */
                 modalTitle.textContent = title; modalMessage.innerHTML = message; appState.modalCallback = confirmCallback; modalConfirmBtn.className = 'btn'; if (type === 'danger') { modalConfirmBtn.classList.add('btn-danger'); modalConfirmBtn.textContent = "Confirmar Eliminació"; } else if (type === 'warning') { modalConfirmBtn.classList.add('btn-warning'); modalConfirmBtn.textContent = "Confirmar"; } else { modalConfirmBtn.classList.add('btn-primary'); modalConfirmBtn.textContent = "Acceptar"; } modalConfirmBtn.style.display = confirmCallback ? '' : 'none'; modalCancelBtn.textContent = confirmCallback ? 'Cancel·lar' : 'Tancar'; confirmationModal.classList.add('visible'); modalConfirmBtn.focus();
            },
            hideModal: () => { /* ... (igual que v5) ... */
                 confirmationModal.classList.remove('visible'); appState.modalCallback = null;
            },
            showFeedback: (message, type = 'success', duration = 3000) => { /* ... (igual que v5) ... */
                 feedbackArea.textContent = message; feedbackArea.className = ''; feedbackArea.classList.add(`feedback-${type}`); feedbackArea.classList.add('visible'); setTimeout(() => { feedbackArea.classList.remove('visible'); }, duration);
             },
            debounce: (func, delay) => { /* ... (igual que v5) ... */
                 let timeoutId; return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => { func.apply(this, args); }, delay); };
             }
        };

        // --- Rendering Functions ---
        const Render = {
            // Main render function (similar to v5, calls new summary render)
            events: () => {
                const allEvents = appState.events;
                let filteredEvents = [...allEvents];

                // 1. Apply Filters (igual que v5)
                const searchTerm = appState.filters.search.toLowerCase().trim(); const filterStatus = appState.filters.status; const filterStartDate = appState.filters.startDate ? new Date(appState.filters.startDate) : null; const filterEndDate = appState.filters.endDate ? new Date(appState.filters.endDate) : null; if (searchTerm || filterStatus || filterStartDate || filterEndDate) { filteredEvents = filteredEvents.filter(event => { const nameMatch = searchTerm ? event.name.toLowerCase().includes(searchTerm) : true; const eventNameMatch = searchTerm ? event.eventName.toLowerCase().includes(searchTerm) : true; const notesMatch = searchTerm ? event.notes.toLowerCase().includes(searchTerm) : true; const statusMatch = filterStatus ? event.status === filterStatus : true; let dateMatch = true; if (event.startDate) { try { const eventDate = new Date(event.startDate); if (filterStartDate) { filterStartDate.setHours(0,0,0,0); if (eventDate < filterStartDate) dateMatch = false; } if (filterEndDate && dateMatch) { filterEndDate.setHours(23,59,59,999); if (eventDate > filterEndDate) dateMatch = false; } } catch (e) { console.error("Error parsing event date for filtering:", event.startDate, e); dateMatch = false; } } else if(filterStartDate || filterEndDate) { dateMatch = false; } return (nameMatch || eventNameMatch || notesMatch) && statusMatch && dateMatch; }); }

                // 2. Apply Sorting (igual que v5)
                const sortKey = appState.sort.key; const sortDir = appState.sort.direction === 'asc' ? 1 : -1; filteredEvents.sort((a, b) => { let valA = a[sortKey]; let valB = b[sortKey]; if (sortKey === 'startDate') { valA = valA ? new Date(valA).getTime() : (sortDir === 1 ? Infinity : -Infinity); valB = valB ? new Date(valB).getTime() : (sortDir === 1 ? Infinity : -Infinity); if (isNaN(valA)) valA = (sortDir === 1 ? Infinity : -Infinity); if (isNaN(valB)) valB = (sortDir === 1 ? Infinity : -Infinity); } else if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); } if (valA < valB) return -1 * sortDir; if (valA > valB) return 1 * sortDir; return 0; });

                // 3. Render Table (igual que v5, usa template)
                eventsTableBody.innerHTML = ''; Render.updateSortIndicators(); if (allEvents.length === 0) { eventsTable.style.display = 'none'; eventsListTitle.style.display = 'none'; summariesSection.style.display = 'none'; filterControlsSection.style.display = 'none'; noEventsMessage.textContent = "Encara no hi ha cap esdeveniment. Comença afegint-ne un!"; noEventsMessage.style.display = 'block'; } else { filterControlsSection.style.display = ''; // Show filters if events exist
                 if (filteredEvents.length === 0) { eventsTable.style.display = 'none'; eventsListTitle.style.display = 'block'; eventCountSpan.textContent = `0 de ${allEvents.length}`; summariesSection.style.display = ''; noEventsMessage.textContent = "No s'han trobat esdeveniments que coincideixin amb els filtres aplicats."; noEventsMessage.style.display = 'block'; } else { eventsTable.style.display = ''; eventsListTitle.style.display = 'block'; eventCountSpan.textContent = `${filteredEvents.length} de ${allEvents.length}`; summariesSection.style.display = ''; noEventsMessage.style.display = 'none'; filteredEvents.forEach(event => { const row = Render.createEventRow(event); eventsTableBody.appendChild(row); }); } }

                 // 4. Update Datalists
                Render.updateDatalists(allEvents);

                // 5. Render NEW Summaries (always based on ALL events)
                Render.renderGroupedSummaries(allEvents);
            },

            // Creates event row using template (igual que v5)
            createEventRow: (event) => {
                 const templateContent = eventRowTemplate.content.cloneNode(true);
                 const row = templateContent.querySelector('tr');
                 row.dataset.id = event.id;
                 const safeStatus = Utils.escapeHTML(event.status);
                 row.className = `status-${safeStatus}`;
                 // Populate cells (order might change based on template)
                 row.querySelector('.event-event-name').textContent = event.eventName;
                 row.querySelector('.event-dates').textContent = Utils.formatDateRange(event.startDate, event.endDate);
                 row.querySelector('.event-person-name').textContent = event.name;
                 row.querySelector('.event-notes').innerHTML = Utils.escapeHTML(event.notes).replace(/\n/g, '<br>');
                 // Status select
                 const statusSelect = row.querySelector('.status-select');
                 statusSelect.value = event.status;
                 statusSelect.dataset.id = event.id;
                 statusSelect.setAttribute('aria-label', `Canviar estat per a ${Utils.escapeHTML(event.eventName)} (${Utils.escapeHTML(event.name)})`);
                 // Action buttons
                 const editBtn = row.querySelector('.edit-btn');
                 const deleteBtn = row.querySelector('.delete-btn');
                 editBtn.dataset.id = event.id;
                 deleteBtn.dataset.id = event.id;
                 editBtn.setAttribute('aria-label', `Editar esdeveniment ${Utils.escapeHTML(event.eventName)} per a ${Utils.escapeHTML(event.name)}`);
                 deleteBtn.setAttribute('aria-label', `Eliminar esdeveniment ${Utils.escapeHTML(event.eventName)} per a ${Utils.escapeHTML(event.name)}`);
                 return row;
            },

            // Updates sort indicators (igual que v5)
             updateSortIndicators: () => { /* ... (igual que v5) ... */
                  eventsTableHeader.querySelectorAll('th[data-sort-key]').forEach(th => { const indicator = th.querySelector('.sort-indicator'); if (th.dataset.sortKey === appState.sort.key) { indicator.textContent = appState.sort.direction === 'asc' ? ' ▲' : ' ▼'; } else { indicator.textContent = ''; } });
             },

             // Updates Datalists (NOU)
             updateDatalists: (events) => {
                 const uniqueEventNames = Utils.getUniqueValues(events, 'eventName');
                 const uniquePersonNames = Utils.getUniqueValues(events, 'name');

                 eventNameDatalist.innerHTML = uniqueEventNames.map(name => `<option value="${Utils.escapeHTML(name)}"></option>`).join('');
                 personNameDatalist.innerHTML = uniquePersonNames.map(name => `<option value="${Utils.escapeHTML(name)}"></option>`).join('');
             },

            // Renders ALL Grouped Summaries (NOU) - Replaces Render.summaries
             renderGroupedSummaries: (events) => {
                 if (!events || events.length === 0) {
                     summariesSection.style.display = 'none';
                     return;
                 }
                 summariesSection.style.display = ''; // Ensure section is visible

                 // --- 1. Group Data ---
                 const groupedByEventName = {};
                 const groupedByDate = {};
                 const groupedByPerson = {};

                 events.forEach(event => {
                     // Group by Event Name (case-insensitive key, store original name)
                     const eventNameKey = (event.eventName || '').trim().toLowerCase();
                     if (eventNameKey) {
                         if (!groupedByEventName[eventNameKey]) groupedByEventName[eventNameKey] = { displayName: event.eventName.trim(), events: [] };
                         groupedByEventName[eventNameKey].events.push(event);
                     }
                     // Group by Start Date
                     if (event.startDate) {
                         if (!groupedByDate[event.startDate]) groupedByDate[event.startDate] = [];
                         groupedByDate[event.startDate].push(event);
                     }
                      // Group by Person Name (case-insensitive key, store original name)
                      const personNameKey = (event.name || '').trim().toLowerCase();
                     if (personNameKey) {
                         if (!groupedByPerson[personNameKey]) groupedByPerson[personNameKey] = { displayName: event.name.trim(), events: [] };
                         groupedByPerson[personNameKey].events.push(event);
                     }
                 });

                  // --- 2. Sort Groups and Events within Groups ---
                  const sortedEventNameKeys = Object.keys(groupedByEventName).sort((a, b) => groupedByEventName[a].displayName.localeCompare(groupedByEventName[b].displayName, 'ca', { sensitivity: 'base' }));
                  sortedEventNameKeys.forEach(key => groupedByEventName[key].events.sort((a, b) => (a.startDate || '').localeCompare(b.startDate || ''))); // Sort events by date within group

                  const sortedDateKeys = Object.keys(groupedByDate).sort(); // Sort dates chronologically
                  sortedDateKeys.forEach(key => groupedByDate[key].sort((a, b) => (a.eventName || '').localeCompare(b.eventName || '', 'ca', { sensitivity: 'base' }))); // Sort events by name within date

                  const sortedPersonKeys = Object.keys(groupedByPerson).sort((a, b) => groupedByPerson[a].displayName.localeCompare(groupedByPerson[b].displayName, 'ca', { sensitivity: 'base' }));
                   sortedPersonKeys.forEach(key => groupedByPerson[key].events.sort((a, b) => (a.startDate || '').localeCompare(b.startDate || ''))); // Sort events by date within person

                 // --- 3. Render Each Summary Table ---
                 Render.renderSingleGroupedSummary(summaryByEventTableBody, noSummaryEventMsg, summaryByEventContainer, sortedEventNameKeys, groupedByEventName,
                     (groupKey, groupData) => `<tr class="summary-group-header"><td colspan="3">Esdeveniment: ${Utils.escapeHTML(groupData.displayName)}</td></tr>`,
                     (event) => `<td data-label="Persona/Grup">${Utils.escapeHTML(event.name)}</td><td data-label="Dates">${Utils.formatDateRange(event.startDate, event.endDate)}</td>`
                 );
                 Render.renderSingleGroupedSummary(summaryByDateTableBody, noSummaryDateMsg, summaryByDateContainer, sortedDateKeys, groupedByDate,
                      (groupKey) => `<tr class="summary-group-header"><td colspan="3">Data Inici: ${Utils.formatSingleDate(groupKey)}</td></tr>`,
                      (event) => `<td data-label="Esdeveniment">${Utils.escapeHTML(event.eventName)}</td><td data-label="Persona/Grup">${Utils.escapeHTML(event.name)}</td>`
                  );
                  Render.renderSingleGroupedSummary(summaryByPersonTableBody, noSummaryPersonMsg, summaryByPersonContainer, sortedPersonKeys, groupedByPerson,
                       (groupKey, groupData) => `<tr class="summary-group-header"><td colspan="3">Persona/Grup: ${Utils.escapeHTML(groupData.displayName)}</td></tr>`,
                       (event) => `<td data-label="Esdeveniment">${Utils.escapeHTML(event.eventName)}</td><td data-label="Dates">${Utils.formatDateRange(event.startDate, event.endDate)}</td>`
                   );
             },

             // Helper to render one grouped summary table (NOU)
             renderSingleGroupedSummary: (tbody, noDataMsg, container, sortedGroupKeys, groupedData, groupHeaderRenderer, eventRowRenderer) => {
                 tbody.innerHTML = '';
                 if (sortedGroupKeys.length === 0) {
                     container.style.display = 'none'; // Hide container if no groups
                 } else {
                      container.style.display = ''; // Show container
                      noDataMsg.style.display = 'none';
                      sortedGroupKeys.forEach(groupKey => {
                          const groupInfo = groupedData[groupKey];
                          // Handle both object structure (name/event) and array structure (date)
                           const eventsInGroup = Array.isArray(groupInfo) ? groupInfo : groupInfo.events;
                           const groupDataForHeader = Array.isArray(groupInfo) ? null : groupInfo; // Pass display name if available

                          // Add group header row
                          tbody.insertAdjacentHTML('beforeend', groupHeaderRenderer(groupKey, groupDataForHeader));

                          // Add rows for events in this group
                          eventsInGroup.forEach(event => {
                              const status = event.status || 'Pendent';
                              const rowHTML = `
                                  <tr>
                                      ${eventRowRenderer(event)}
                                      <td data-label="Estat">
                                          <span class="status-indicator status-indicator-${status}">${Utils.escapeHTML(status)}</span>
                                      </td>
                                  </tr>
                              `;
                              tbody.insertAdjacentHTML('beforeend', rowHTML);
                          });
                     });
                 }
             },

             // Set form mode (igual que v5)
             setFormMode: (mode, event = null) => { /* ... (igual que v5) ... */
                  eventForm.reset(); if (mode === 'edit' && event) { appState.editingEventId = event.id; editEventIdInput.value = event.id; formTitle.childNodes[1].textContent = " Editar Esdeveniment"; submitBtnText.textContent = "Desar Canvis"; cancelEditBtn.classList.remove('hidden'); personNameInput.value = event.name; eventNameInput.value = event.eventName; startDateInput.value = event.startDate; endDateInput.value = event.endDate; statusInput.value = event.status; notesInput.value = event.notes; personNameInput.focus(); } else { appState.editingEventId = null; editEventIdInput.value = ''; formTitle.childNodes[1].textContent = " Afegir Esdeveniment"; submitBtnText.textContent = "Afegir"; cancelEditBtn.classList.add('hidden'); }
             }
        };

        // --- Event Handlers (mostly similar to v5, adapt where needed) ---
        const Handlers = {
            formSubmit: (e) => { /* ... (igual que v5, ensures eventName is saved) ... */
                 e.preventDefault(); const idToEdit = appState.editingEventId; const personNameValue = personNameInput.value.trim(); const eventNameValue = eventNameInput.value.trim(); const startDateValue = startDateInput.value; const endDateValue = endDateInput.value; if (!eventNameValue) { alert("El nom de l'esdeveniment és obligatori."); eventNameInput.focus(); return; } if (!startDateValue) { alert("La data d'inici és obligatòria."); startDateInput.focus(); return; } if (!personNameValue) { alert("El nom de la persona/grup és obligatori."); personNameInput.focus(); return; } if (!/^\d{4}-\d{2}-\d{2}$/.test(startDateValue)) { alert("Format de data d'inici invàlid (AAAA-MM-DD)."); startDateInput.focus(); return; } if (endDateValue) { if (!/^\d{4}-\d{2}-\d{2}$/.test(endDateValue)) { alert("Format de data fi invàlid (AAAA-MM-DD)."); endDateInput.focus(); return; } try { const start = new Date(startDateValue); const end = new Date(endDateValue); if (end < start) { alert("La data fi no pot ser anterior a la data d'inici."); endDateInput.focus(); return; } } catch (err) { console.error("Error comparing dates:", err); } } const eventData = { name: personNameValue, eventName: eventNameValue, startDate: startDateValue, endDate: endDateValue || null, status: statusInput.value, notes: notesInput.value.trim() }; if (idToEdit) { const eventIndex = appState.events.findIndex(event => event.id === idToEdit); if (eventIndex > -1) { appState.events[eventIndex] = { ...appState.events[eventIndex], ...eventData }; Utils.showFeedback("Esdeveniment actualitzat correctament."); } else { console.error("Event ID to edit not found:", idToEdit); Utils.showFeedback("Error: No s'ha trobat l'esdeveniment per editar.", 'error'); Render.setFormMode('add'); return; } } else { eventData.id = Date.now() + Math.random(); appState.events.push(eventData); Utils.showFeedback("Esdeveniment afegit correctament."); } Utils.saveEvents(appState.events); Render.setFormMode('add'); Render.events(); // Rerender all
            },
            tableClick: (e) => { /* ... (igual que v5, edit/delete logic) ... */
                 const editButton = e.target.closest('.edit-btn'); const deleteButton = e.target.closest('.delete-btn'); if (editButton) { const eventId = parseInt(editButton.dataset.id, 10); const eventToEdit = appState.events.find(event => event.id === eventId); if (eventToEdit) { Render.setFormMode('edit', eventToEdit); eventForm.scrollIntoView({ behavior: 'smooth' }); } else { console.error("Event not found for editing:", eventId); Utils.showFeedback("Error: No s'ha trobat l'esdeveniment per editar.", 'error'); } } else if (deleteButton) { const eventId = parseInt(deleteButton.dataset.id, 10); const eventToDelete = appState.events.find(event => event.id === eventId); if (eventToDelete) { const confirmMsg = `Segur que vols eliminar l'esdeveniment: <br><strong>${Utils.escapeHTML(eventToDelete.eventName)}</strong> per a <strong>${Utils.escapeHTML(eventToDelete.name)}</strong>? <br><br>Aquesta acció no es pot desfer.`; Utils.showModal( "Confirmar Eliminació", confirmMsg, () => { appState.events = appState.events.filter(event => event.id !== eventId); Utils.saveEvents(appState.events); Render.events(); Utils.showFeedback("Esdeveniment eliminat."); Utils.hideModal(); if (appState.editingEventId === eventId) { Render.setFormMode('add'); } }, 'danger' ); } else { console.error("Event not found for deletion:", eventId); Utils.showFeedback("Error: No s'ha trobat l'esdeveniment per eliminar.", 'error'); } }
            },
            tableChange: (e) => { /* ... (igual que v5, status change) ... */
                 if (e.target.classList.contains('status-select')) { const select = e.target; const eventId = parseInt(select.dataset.id, 10); const newStatus = select.value; const eventIndex = appState.events.findIndex(event => event.id === eventId); if (eventIndex > -1) { appState.events[eventIndex].status = newStatus; Utils.saveEvents(appState.events); const row = select.closest('tr'); if (row) { row.className = ''; row.classList.add(`status-${Utils.escapeHTML(newStatus)}`); } Render.renderGroupedSummaries(appState.events); // Update summaries Utils.showFeedback("Estat actualitzat."); } else { console.warn("Event ID not found for status update:", eventId); Utils.showFeedback("Error actualitzant l'estat.", 'error'); Render.events(); } }
             },
            filterChange: Utils.debounce(() => { /* ... (igual que v5) ... */
                  appState.filters.search = filterSearchInput.value; appState.filters.status = filterStatusSelect.value; appState.filters.startDate = filterStartDateInput.value; appState.filters.endDate = filterEndDateInput.value; Render.events();
             }, DEBOUNCE_DELAY),
            directFilterChange: () => { /* ... (igual que v5) ... */
                 appState.filters.status = filterStatusSelect.value; appState.filters.startDate = filterStartDateInput.value; appState.filters.endDate = filterEndDateInput.value; Render.events();
             },
            resetFilters: () => { /* ... (igual que v5) ... */
                 filterSearchInput.value = ''; filterStatusSelect.value = ''; filterStartDateInput.value = ''; filterEndDateInput.value = ''; appState.filters = { search: '', status: '', startDate: '', endDate: '' }; Render.events();
             },
            headerClick: (e) => { /* ... (igual que v5, sorting) ... */
                  const th = e.target.closest('th[data-sort-key]'); if (!th) return; const newSortKey = th.dataset.sortKey; if (appState.sort.key === newSortKey) { appState.sort.direction = appState.sort.direction === 'asc' ? 'desc' : 'asc'; } else { appState.sort.key = newSortKey; appState.sort.direction = 'asc'; } Render.events();
             },
            clearForm: () => { Render.setFormMode('add'); },
            cancelEdit: () => { Render.setFormMode('add'); },
            modalConfirm: () => { if (typeof appState.modalCallback === 'function') { appState.modalCallback(); } Utils.hideModal(); },
            modalCancel: () => { Utils.hideModal(); },
            handleExport: () => { /* ... (igual que v5) ... */
                 if (appState.events.length === 0) { Utils.showFeedback("No hi ha dades per exportar.", 'warning'); return; } try { const dataStr = JSON.stringify(appState.events, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); const timestamp = new Date().toISOString().slice(0, 10); link.download = `esdeveniments_${timestamp}.json`; link.href = url; link.click(); URL.revokeObjectURL(url); Utils.showFeedback("Dades exportades correctament."); } catch (e) { console.error("Error exporting data:", e); Utils.showFeedback("Error exportant les dades.", 'error'); }
            },
            handleImportTrigger: () => { importFileInput.click(); },
            handleFileImport: (e) => { /* ... (igual que v5, amb prompt replace/merge) ... */
                  const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const importedData = JSON.parse(event.target.result); if (!Array.isArray(importedData)) { throw new Error("El fitxer JSON no conté un array."); } const isValid = importedData.every(item => typeof item === 'object' && item !== null && 'name' in item && 'eventName' in item && 'startDate' in item ); if (!isValid) { throw new Error("Algunes entrades del fitxer JSON no tenen el format esperat (name, eventName, startDate)."); } Utils.showModal( "Importar Dades", `S'han trobat ${importedData.length} esdeveniments al fitxer. Vols <strong>reemplaçar</strong> les dades actuals o <strong>afegir</strong> les noves a les existents?`, () => {}, 'warning' ); const originalConfirmHandler = Handlers.modalConfirm; const originalCancelHandler = Handlers.modalCancel; modalConfirmBtn.textContent = "Reemplaçar"; modalConfirmBtn.onclick = () => { appState.events = importedData.map(event => ({ ...event, id: event.id || Date.now() + Math.random(), status: event.status || 'Pendent', notes: event.notes || '' })); Utils.saveEvents(appState.events); Render.events(); Utils.hideModal(); Utils.showFeedback("Dades importades (reemplaçades) correctament."); modalConfirmBtn.onclick = originalConfirmHandler; modalCancelBtn.onclick = originalCancelHandler; }; modalCancelBtn.textContent = "Afegir"; modalCancelBtn.onclick = () => { const mergedEvents = [...appState.events]; importedData.forEach(item => { mergedEvents.push({ ...item, id: Date.now() + Math.random(), status: item.status || 'Pendent', notes: item.notes || '' }); }); appState.events = mergedEvents; Utils.saveEvents(appState.events); Render.events(); Utils.hideModal(); Utils.showFeedback(`S'han afegit ${importedData.length} esdeveniments.`); modalConfirmBtn.onclick = originalConfirmHandler; modalCancelBtn.onclick = originalCancelHandler; }; } catch (err) { console.error("Error importing data:", err); Utils.showModal( "Error d'Importació", `No s'ha pogut importar el fitxer: ${Utils.escapeHTML(err.message)}`, null, 'error' ); } finally { importFileInput.value = ''; } }; reader.onerror = () => { Utils.showModal("Error d'Importació", "No s'ha pogut llegir el fitxer seleccionat.", null, 'error'); importFileInput.value = ''; }; reader.readAsText(file);
            },
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            appState.events = Utils.getEvents(); // Load initial data

            // Attach Event Listeners
            eventForm.addEventListener('submit', Handlers.formSubmit);
            clearFormBtn.addEventListener('click', Handlers.clearForm);
            cancelEditBtn.addEventListener('click', Handlers.cancelEdit);
            filterSearchInput.addEventListener('input', Handlers.filterChange);
            filterStatusSelect.addEventListener('change', Handlers.directFilterChange);
            filterStartDateInput.addEventListener('change', Handlers.directFilterChange);
            filterEndDateInput.addEventListener('change', Handlers.directFilterChange);
            resetFiltersBtn.addEventListener('click', Handlers.resetFilters);
            eventsTableBody.addEventListener('click', Handlers.tableClick);
            eventsTableBody.addEventListener('change', Handlers.tableChange);
            eventsTableHeader.addEventListener('click', Handlers.headerClick);
            modalConfirmBtn.addEventListener('click', Handlers.modalConfirm); // Generic handler
            modalCancelBtn.addEventListener('click', Handlers.modalCancel);   // Generic handler
            exportBtnTop.addEventListener('click', Handlers.handleExport);
            importBtnTop.addEventListener('click', Handlers.handleImportTrigger);
             exportBtnBottom.addEventListener('click', Handlers.handleExport); // Both trigger same function
            importBtnBottom.addEventListener('click', Handlers.handleImportTrigger); // Both trigger same function
            importFileInput.addEventListener('change', Handlers.handleFileImport);

            Render.events(); // Initial Render
        });

    </script>

</body>
</html>